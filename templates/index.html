<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship Tracker</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --rosewater: #f5e0dc; --flamingo: #f2cdcd; --pink: #f5c2e7; --mauve: #cba6f7;
            --red: #f38ba8; --maroon: #eba0ac; --peach: #fab387; --yellow: #f9e2af;
            --green: #a6e3a1; --teal: #94e2d5; --sky: #89dceb; --sapphire: #74c7ec;
            --blue: #89b4fa; --lavender: #b4befe; --text: #cdd6f4; --subtext1: #bac2de;
            --subtext0: #a6adc8; --overlay2: #9399b2; --overlay1: #7f849c; --overlay0: #6c7086;
            --surface2: #585b70; --surface1: #45475a; --surface0: #313244; --base: #1e1e2e;
            --mantle: #181825; --crust: #11111b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--crust);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: auto; background: var(--base); padding: 25px; border-radius: 12px; border: 1px solid var(--surface0); }
        h1, h2 { color: var(--mauve); }
        h1 { text-align: center; }
        a { color: var(--blue); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { padding: 12px; border: 1px solid var(--surface0); text-align: left; vertical-align: middle; word-wrap: break-word; }
        th { background-color: var(--mantle); }
        th a { text-decoration: none; color: var(--subtext1); }
        th a:hover { color: var(--mauve); }
        .form-row input, .form-row select, .form-row button, .controls-form input, .controls-form select, .controls-form button, .update-status-form select {
            padding: 10px; border-radius: 8px; border: 1px solid var(--surface1); font-size: 1rem;
            background-color: var(--mantle); color: var(--text);
        }
        ::placeholder { color: var(--overlay1); }
        .form-row button, .controls-form button { background-color: var(--blue); color: var(--crust); border: none; cursor: pointer; white-space: nowrap; }
        .form-row button:hover, .controls-form button:hover { background-color: var(--sapphire); }
        .form-section { padding: 20px; background: var(--mantle); border-radius: 8px; margin-bottom: 30px; border: 1px solid var(--surface0); }
        #sankey-diagram { width: 100%; height: 450px; }
        .controls-form { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .current-sort { font-weight: bold; color: var(--mauve); }
        .actions-cell { text-align: center; width: 40px; }
        .actions-menu { position: relative; display: inline-block; }
        .actions-button { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; line-height: 1; color: var(--overlay2); }
        .actions-menu-content { display: none; position: absolute; right: 0; background-color: var(--mantle); min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; overflow: hidden; border: 1px solid var(--surface1); }
        .actions-menu-content a, .actions-menu-content button { color: var(--text); padding: 10px 15px; text-decoration: none; display: block; width: 100%; text-align: left; background: none; border: none; font-size: 0.9rem; }
        .actions-menu-content a:hover, .actions-menu-content button:hover { background-color: var(--surface0); }
        .actions-menu:hover .actions-menu-content { display: block; }
        .delete-button { color: var(--red) !important; }
        .note-content { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-content.expanded { white-space: normal; overflow: visible; }
        .toggle-note { font-size: 0.8em; color: var(--sky); cursor: pointer; display: block; margin-top: 5px; font-weight: bold; }
        .toggle-note:hover { text-decoration: underline; }
        .update-status-form select { width: 100%; cursor: pointer; }
        /* --- NEW STYLES for personal links --- */
        .personal-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .link-item { display: flex; align-items: center; background-color: var(--mantle); padding: 8px 15px; border-radius: 8px; border: 1px solid var(--surface0); }
        .link-item a { margin-right: 10px; text-decoration: none; font-weight: bold; }
        .copy-btn { background-color: var(--surface1); color: var(--text); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .copy-btn:hover { background-color: var(--surface2); }
    </style>
</head>
<body>
    <div class="container">
        <h1>CS Internship Pipeline</h1>
        
        {% if personal_links %}
        <div class="personal-links">
            {% if personal_links.linkedin %}
            <div class="link-item">
                <a href="{{ personal_links.linkedin }}" target="_blank">LinkedIn</a>
                <button class="copy-btn" onclick="copyToClipboard('{{ personal_links.linkedin }}')">Copy</button>
            </div>
            {% endif %}
            {% if personal_links.github %}
            <div class="link-item">
                <a href="{{ personal_links.github }}" target="_blank">GitHub</a>
                <button class="copy-btn" onclick="copyToClipboard('{{ personal_links.github }}')">Copy</button>
            </div>
            {% endif %}
            {% if personal_links.personal_website %}
            <div class="link-item">
                <a href="{{ personal_links.personal_website }}" target="_blank">Website</a>
                <button class="copy-btn" onclick="copyToClipboard('{{ personal_links.personal_website }}')">Copy</button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div id="sankey-diagram"></div>
        <hr style="margin: 40px 0; border-color: var(--surface0);">
        
        <h2>Add New Application</h2>
        <div class="form-section">
            <form action="{{ url_for('add_application') }}" method="post" class="form-row" style="gap: 10px;">
                <input type="text" name="company" placeholder="Company" style="flex-grow: 1;" required>
                <input type="text" name="role" placeholder="Role" style="flex-grow: 1;" required>
                <input type="text" name="notes" placeholder="Notes (e.g., URL)" style="flex-grow: 2;">
                <button type="submit">Add Application</button>
            </form>
        </div>
        
        <h2>Current Applications</h2>
        <div class="form-section">
            <form action="{{ url_for('index') }}" method="get" class="controls-form">
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                <input type="text" name="search" placeholder="Search by keyword..." value="{{ search_query }}">
                <select name="filter_status" onchange="this.form.submit()">
                    <option value="All" {% if filter_status == 'All' %}selected{% endif %}>Filter by Stage: All</option>
                    {% for status_option in status_stages %}<option value="{{ status_option }}" {% if filter_status == status_option %}selected{% endif %}>{{ status_option }}</option>{% endfor %}
                </select>
                <button type="submit">Search</button>
                <button type="button" onclick="window.location.href='{{ url_for('index') }}'">Clear All</button>
            </form>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th style="width: 15%;"><a href="{{ url_for('index', sort_by='company', search=search_query, filter_status=filter_status) }}" class="{{ 'current-sort' if sort_by == 'company' else '' }}">Company</a></th>
                    <th style="width: 15%;">Role</th>
                    <th style="width: 10%;"><a href="{{ url_for('index', sort_by='date_applied_desc', search=search_query, filter_status=filter_status) }}" class="{{ 'current-sort' if sort_by == 'date_applied_desc' else '' }}">Date Added</a></th>
                    <th style="width: 10%;"><a href="{{ url_for('index', sort_by='status', search=search_query, filter_status=filter_status) }}" class="{{ 'current-sort' if sort_by == 'status' else '' }}">Status</a></th>
                    <th style="width: 25%;">Notes</th>
                    <th style="width: 20%;">Update Status</th>
                    <th style="width: 5%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr>
                    <td>{{ app.company }}</td>
                    <td>{{ app.role }}</td>
                    <td>{{ app.date_applied.strftime('%Y-%m-%d') }}</td>
                    <td>{{ app.status }}</td>
                    <td>
                        {% if app.notes and app.notes|length > 50 %}
                            <div class="note-content">{{ app.notes }}</div>
                            <a class="toggle-note" onclick="toggleNote(this)">Show more</a>
                        {% else %}
                            {{ app.notes }}
                        {% endif %}
                    </td>
                    <td>
                        <form class="update-status-form" action="{{ url_for('update_status', app_id=app.id, search=search_query, sort_by=sort_by, filter_status=filter_status) }}" method="post">
                            <select name="status" onchange="this.form.submit()">
                                {% for status_option in status_stages %}<option value="{{ status_option }}" {% if app.status == status_option %}selected{% endif %}>{{ status_option }}</option>{% endfor %}
                            </select>
                        </form>
                    </td>
                    <td class="actions-cell">
                        <div class="actions-menu">
                            <button class="actions-button">&#8942;</button>
                            <div class="actions-menu-content">
                                <a href="{{ url_for('edit_application', app_id=app.id) }}">Edit</a>
                                <form action="{{ url_for('delete_application', app_id=app.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this application?');">
                                    <button type="submit" class="delete-button">Delete</button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="7" style="text-align: center;">No applications found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // --- NEW: Clipboard function ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('Copied to clipboard!');
            }, function(err) {
                alert('Could not copy text: ', err);
            });
        }

        function parseJsonData(jsonString) { try { return JSON.parse(jsonString); } catch (e) { console.error("Failed to parse JSON data:", e); return null; } }
        const sankeyData = parseJsonData('{{ sankey_data|safe }}');

        if (sankeyData && sankeyData.nodes && sankeyData.links && sankeyData.links.source && sankeyData.links.source.length > 0) {
            const plotDiv = document.getElementById('sankey-diagram');
            const data = [{
                type: "sankey",
                orientation: "h",
                arrangement: "snap",
                node: {
                    pad: 15,
                    thickness: 20,
                    line: { color: "#181825", width: 0.5 },
                    label: sankeyData.nodes.label,
                    color: sankeyData.nodes.color
                },
                link: {
                    source: sankeyData.links.source,
                    target: sankeyData.links.target,
                    value: sankeyData.links.value,
                    color: sankeyData.links.color
                }
            }];
            const layout = { title: { text: "Application Funnel", font: { color: '#cdd6f4' } }, font: { size: 12, color: '#cdd6f4' }, plot_bgcolor: '#1e1e2e', paper_bgcolor: '#1e1e2e' };

            Plotly.newPlot(plotDiv, data, layout);

            plotDiv.on('plotly_click', function(data) {
                const point = data.points[0];
                if (point && point.value !== undefined && point.label === undefined) {
                    const targetLabel = point.target.label;
                    const cleanTargetLabel = targetLabel.split(" ").pop();
                    const currentSearch = {{ search_query|tojson }};
                    const currentSort = {{ sort_by|tojson }};
                    const params = new URLSearchParams();
                    params.set('filter_status', cleanTargetLabel);
                    params.set('sort_by', currentSort);
                    params.set('search', currentSearch);
                    window.location.search = params.toString();
                }
            });

        } else {
            document.getElementById('sankey-diagram').innerHTML = '<p style="text-align:center; color:#a6adc8;">Add applications to see your pipeline visualization.</p>';
        }

        function toggleNote(element) {
            const noteContent = element.previousElementSibling;
            noteContent.classList.toggle('expanded');
            element.textContent = noteContent.classList.contains('expanded') ? 'Show less' : 'Show more';
        }
    </script>
</body>
</html>
